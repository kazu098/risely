# risely 技術設計

## データ取得ポリシー：リアルタイム連携は不要

### 基本方針

リアルタイムでやる必要は**ない**。

むしろ、リアルタイムを目指すと**ほぼ確実に破綻する可能性が高い**。

結論：

> **MVPでは「1日1〜2回のバッチ取得＋バッチ型アドバイス」で十分。

> リアルタイム連携は"やらない方がいい贅沢機能"。**

---

## なぜリアルタイム連携がいらないのか

### (1) ユースケース的にメリットが薄い

このサービスは、

* 「今まさに心拍が上がったから5分瞑想しろ」

* 「いまHRVが落ちたから会議を延期しろ」

みたいな**秒単位・分単位の介入**を本質価値にしていない。

目指しているのは：

* 昨日の睡眠・HRV・アクティビティ

* 今日の予定（カレンダー）

* 生活パターンの因果

  → それを踏まえた**今日の過ごし方（マクロな提案）**。

これは**日単位～半日単位の粒度**で十分に成立する。

リアルタイムに数値を追いかけても、

ユーザーは予定をそんな頻度では変えられない。

### (2) ノイズが多すぎる

リアルタイムの心拍・ストレススコア・ステップはノイジー。

* たまたま階段登った

* 子どもを抱っこして走った

* エレベーターに軽く走って乗った

こういうものまで「ストレス」扱いすると、

**通知が多すぎてユーザーが離脱する**可能性が高い。

統計的・因果的に意味が出るのは、

**ある程度まとまった時間（数時間〜1日）を集計してから**。

### (3) インフラ・実装コストに対してリターンが小さすぎる

リアルタイムを真面目にやるなら：

* Webhook / PubSub / ストリーミング

* 高頻度書き込み

* アラート判定のリアルタイム処理

* 通知のスパム制御

これらを全部やる必要がある。

**ユーザーが感じる体験価値の増加と、実装コストが釣り合わない。**

MVPでやるべきことではない。

---

## 最適解：バッチ型＋1日1〜2回の処理

サービスの本質は**「考えること」**であって、

**「秒単位で監視すること」ではない**。

### データ取得ポリシー（MVP版）

#### ① 朝のバッチ（必須・メイン）

* 取得するもの：

  * 昨夜〜今朝までの睡眠データ（総時間、深い睡眠、覚醒回数、入眠時間など）

  * HRV / レディネススコア

  * 昨日の活動量・歩数・ストレス傾向

  * 今日のGoogleカレンダーの予定一覧（会議密度、負荷）

* これをもとに出すアウトプット：

  * 「今日のエネルギープロファイル（午前/午後のざっくり傾向）」

  * 「今日の1つだけの行動提案（例：寝不足なので○時〜○時は単純タスクに寄せろ）」

  * 「今日やらない方がいいこと（例：カフェイン追加禁止 / 22:30以降のスマホ禁止）」

→ **ここがサービスの"メイン価値"になる。**

#### ② 夕方 or 夜のバッチ（あると良い）

* 取得するもの：

  * その日の日中アクティビティ（歩数、移動量、心拍のざっくり傾向）

  * カレンダー実績（実際にどれだけ予定が詰まっていたか）

  * スマホ利用時間（特に夜）

* これをもとに：

  * 今日1日をざっくり振り返り（「今日は会議詰め＆夜スマホ長すぎ」など）

  * 翌朝に反映する因果モデルのアップデート

ここも「リアルタイム」ではなくて**1日1回で十分**。

### 更新頻度のイメージ

* ウェアラブル → **1日1〜2回のpull / webhook反映**

* カレンダー → **朝の一括取得＋必要なら数時間おきの軽いsync**（でもMVPでは朝一発で充分）

* スマホ操作 → アプリ内でログを貯めておいて、**バッチでまとめて送信**

**「常に最新じゃなくていい」**と最初から割り切る。

---

## データベース負荷と実装コスト

リアルタイムにするかどうかは、

**技術的快楽か、ビジネス的合理性か**の選択の問題。

ビジネスとして合理的なのは：

> **日次・半日単位のバッチ処理で済ませる設計**

### 実装簡略化のための方針

* ウェアラブルの「生データ（数秒ごとの心拍）」は**保存しない**

* すでに各サービスが出している**日次スコア（睡眠スコア、レディネス、アクティビティスコア）＋軽い集計値**だけ保存

* 自前の集計も「1時間単位など」「1日単位」に圧縮

それだけでも因果モデルは十分動く。

やるべきことは**「精度の高いアルゴリズム」ではなく「有益な仮説と提案」**。

---

## MVPの実際のフロー

### 朝 6:00〜7:00 の処理（バッチ or on-demand）

1. ユーザがアプリを開く or 通知をタップ

2. バックエンドが以下を取得

   * 昨晩の睡眠情報（API経由で直近のnight sessionを1件取得）

   * 最新のHRV / readiness / activity score

   * 今日のカレンダー予定一覧（終日のイベント含む）

3. モデルがざっくり判定

   * 「今日は疲労高め / 普通 / かなり回復」

   * 「会議過多 / 移動多め / 家事育児負荷高め」

4. LLMに渡して自然言語のアドバイスを生成

   * 「今日は○○に注意」「○○時〜○○時の過ごし方」

### 夜 21:00〜23:00 の処理

* 日中のアクティビティとスマホ利用（ある程度集計されたデータ）を取得

* 「今日の疲労要因トップ2」を簡単に出す

* それを翌朝の学習に使う（モデル更新用）

全部**バッチで間に合う**。

---

## 技術的実装可能性

技術的には**実装可能**。

ただし、**ちゃんと割り切って設計すれば**という条件付き。

以下を欲張ると破綻する可能性が高い：

* 巨大なディープラーニング

* リアルタイムのミリ秒反応

* 完全自動の"真の因果推論"

現実的に **実装可能なライン** を、データ設計・アルゴリズム・キャリブレーション期間まで具体的に落とす。

### 技術的に可能か？

やろうとしていることを分解すると：

* 日単位の集計データを

* 数週間〜数ヶ月貯めて

* 「どの日はコンディションが良かったか」をラベルにして

* どんな行動（睡眠・会議・スマホ）がそれに効いていそうかを

* 個人ごとに推定して

* そこから「今日の1手」を出す

これは **日次バッチ + 個人単位の軽量モデル** で十分に実装できるレベル。

---

## 具体的に使うデータ（MVP版）

### ① ウェアラブル（必須）

1ユーザー1日あたりでまとめる日次特徴量：

* **睡眠**

  * total_sleep_minutes

  * deep_sleep_ratio (%)

  * sleep_onset_latency（入眠までの時間）

  * number_of_awakenings

* **回復 / ストレス**

  * HRV（夜間平均 or readinessスコア）

  * resting_heart_rate

  * readiness_score（Oura系なら）

* **活動**

  * steps

  * activity_score

  * 中〜高強度活動時間（分）

これを「**前日行動の結果指標**」として扱う。

### ② カレンダー（あった方がいい / MVPで入れるべき）

1日あたり：

* total_events_count

* meeting_events_count（参加者 > 2人 & online会議などの条件でフィルタ）

* total_meeting_minutes

* "重そうな予定"の有無（長時間ミーティング、出張フラグなど）

* 朝/昼/夜の会議密度（タイムスロットごとの件数）

これが「**仕事負荷・社会的ストレスのproxy**」。

### ③ スマホ（段階的に）

最初は無理しない。

現実的なMVPはこのくらい：

* app_total_usage_minutes_per_day

* night_phone_usage_minutes（22:00–翌2:00）

将来拡張するなら：

* SNS/動画カテゴリ別時間

* アプリ切り替え頻度

* （アプリ内）スクロール・タップ頻度

### ④ ラベル（＝"何を良しとするか"）

**ユーザーに日記を書かせない前提**なので、

ラベルは基本的にこれで良い：

* 翌朝の **readiness_score**

* または HRV, resting_HR を組み合わせた「自前のコンディションスコア」

つまり：

> 「ある1日の行動（睡眠・会議・スマホなど） → 翌朝のコンディション」

このマッピングを**個人別に学習**する。

---

## アルゴリズムの段階的アプローチ

難しいことをやりたがると破綻するので、

**段階を決めておく**。

### ステージ0：ルールベース（初期数日）

学習データがほぼない期間は、

**医学・睡眠科学・行動科学ベースのハードコードルール**で対応。

例：

* 睡眠 < 6h → 「今日は脳のパフォーマンス低下リスク高」

* readiness_score が閾値以下 → 「高ストレス日」と仮定

* 夜のスマホ > 60分 → 「深い睡眠低下リスク」

この時点では「**パーソナライズ度低いが、それっぽい提案**」を出す。

### ステージ1：個人別の単純な回帰モデル

日ごとの特徴量 `X` と、翌朝のコンディション `Y` を使う：

* モデル例：

  * 線形回帰 / Elastic Net

  * ランダムフォレスト（木の深さを浅く）

  * LightGBM（やりすぎ注意だが実装は簡単）

式イメージ：

> Y = f(

> sleep_hours, deep_ratio, night_phone, meeting_minutes, steps, …

> )

ここで重要なのは **「精度」ではなく「重みの解釈」**。

* night_phone_usage の係数が大きい → 「あなたは夜スマホが最大の敵」

* meeting_minutes_next_day の係数が大きい → 「会議詰めが疲労の主因」

* steps がプラスに寄与 → 「運動＝むしろ回復になっているタイプ」

この「重みランキング」から **"今日の1手を選ぶ"**。

### ステージ2：時系列・因果っぽいこと（後回しで良い）

余裕が出てからでいいが、やると強いのは：

* ラグ付き特徴（2日前、3日前の行動も入れる）

* 「ある行動の増加 → スコア悪化」が継続的かを見る（擬似因果）

* 個人ごとの SHAP バリューで説明

ここまで行けば、ユーザーに対して：

> 「過去30日間のデータから、

> あなたの睡眠を最も悪化させている要因トップ3はこれです」

みたいなことが言える。

### 自然言語化（アドバイス生成）はLLMで十分

モデルから出るのは：

* 今日のコンディション（low / medium / high）

* そのコンディションに効いていそうな行動の重みトップ3

* そのうち「ユーザーが変えられそうなもの」1つ

これをプロンプトにして LLM に渡して：

> 「今日の状態」「ユーザーの行動特徴」「避けるべきこと」「推奨行動」

> を元に、1つだけアドバイス文を生成

で終わる。

---

## キャリブレーション期間

ここを適当にするとユーザー体験が壊れる。

### 結論：

* **最低：7日**（「何となくあなたらしさ」が出始めるライン）

* **推奨：「21〜30日」で本格的なパターン抽出**

具体的な運用イメージ：

### Day 0〜3：ほぼルールベース

* 睡眠不足 / readiness 悪化の日に

* 汎用ルールでアドバイス

* 「まだあなたのパターン学習中です」と明示

### Day 4〜7：軽いパーソナライズ開始

* まだデータ少ないが、

  「夜スマホ長い日 = readiness 低い」みたいな粗い傾向は見える

* 「ここ数日、○○のときに疲れてそう」という言い方で"仮説レベル"を提示

### Day 8〜21：個人モデルがだいぶマシになってくる

* 単純回帰でも「何が効いていそうか」が見えてくる

* 週次レポートで

  > 「過去2週間で、あなたの疲労と強く関連しているのは ○○ です」

  > みたいなインサイトを出せる

### Day 21〜30以降：ようやく"あなた仕様"と言っていいレベル

* 上位要因がかなり安定してくる

* このタイミングで「あなたの生活パターンマップ」を見せると強い

---

## 現実的な制約と注意点

### 注意点1：

> 「精度高いモデルが必要なのでは？」

違う。

必要なのは **"数字として完全に正しい予測" ではなく**

**"ユーザーの体感とズレすぎない因果のストーリー"**。

多少ノイズがあっても、

> 「あー確かに、夜スマホ長いとだいたい次の日きついわ」

と思わせられれば良い。

### 注意点2：

> 「データが少ないうちは価値がないのでは？」

違う。

キャリブレーション期間中でも、

* 既存の睡眠科学・行動科学に基づく汎用アドバイス

* 「あなたのデータをこういう形で使っていきます」という見せ方

これだけでも「期待感」を売れる。

むしろ **「学習して賢くなっていく感」** 自体が価値になる。

---

## 技術実装のまとめ

* 技術的には **十分可能**。

* 必要データ：

  * 日次の睡眠・HRV・活動（ウェアラブル）

  * カレンダーの負荷指標

  * 夜スマホ時間（あれば尚良し）

* アルゴリズム：

  * スタート：ルールベース

  * → 個人ごとの単純回帰 / 木系モデル

  * → 因果っぽいランキングから「今日の1手」を選ぶ

* キャリブレーション：

  * 最低7日、真面目にやるなら21〜30日で"あなた仕様"になる

ここまでスコープを絞っているなら、

**これは「難しい研究プロジェクト」ではなく、ちゃんと設計されたSaaSプロダクト**として実装可能。

---

## 将来の拡張：リアルタイムが"あり得るか"

将来的に、もし以下のような**明確な高付加価値ユースケース**が見えたら、そのとき初めてリアルタイムを検討すればいい。

* パニック発作・強いストレス発生時に即座に介入する

* 長時間座位・血栓リスク・不整脈などに対して即アラート

* アスリート向けのリアルタイムパフォーマンス計測

でもこれは**医療寄り or 特殊なニッチ**。

今のコンセプト（一般ビジネスパーソンの疲労・集中の最適化）からは外れている。

