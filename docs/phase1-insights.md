# Phase 1 インサイト：Apple Healthデータのみから得られる気づき

## 概要

Phase 1では、**Apple Healthデータ（睡眠、HRV、心拍数、歩数、アクティブエネルギー）のみ**から、ユーザーが気づいていないパターンやインサイトを提供します。

カレンダーやスマホ利用時間のデータがなくても、**生体データだけから十分に価値のあるインサイト**を得ることができます。

---

## インサイトのカテゴリ

### 1. 睡眠の質とHRVの関係

#### インサイト例

**「同じ睡眠時間でも、深い睡眠の割合が10%違うだけでHRVが20%変動しています」**

* **発見方法**:
  * 睡眠時間が同じ（例：7時間）の日を抽出
  * 深い睡眠の割合でグループ化
  * 各グループのHRV平均値を比較

* **ユーザーが気づいていない点**:
  * 「睡眠時間は同じなのに、なぜか疲れが違う」という体感の理由が数値で明確になる
  * 深い睡眠の重要性を実感できる

**「深い睡眠が20%未満の日の翌日は、リカバリースコアが平均15pt低下しています」**

* **発見方法**:
  * 深い睡眠の割合で日を分類
  * 翌日のリカバリースコアを比較

* **ユーザーが気づいていない点**:
  * 深い睡眠の割合が回復に与える影響を数値で理解できる

---

### 2. HRVのパターン発見

#### インサイト例

**「あなたのHRVは、週の後半（木曜〜土曜）に平均的に低くなる傾向があります」**

* **発見方法**:
  * 曜日ごとのHRV平均値を計算
  * 週の前半と後半で比較

* **ユーザーが気づいていない点**:
  * 週の疲労の蓄積パターンが可視化される
  * 「週末は疲れている」という体感の理由が明確になる

**「HRVがベースラインより15%以上低い日は、その3日前から睡眠の質が低下し始めています」**

* **発見方法**:
  * HRVが低い日を特定
  * その3日前からの睡眠データを分析

* **ユーザーが気づいていない点**:
  * 疲労の蓄積は数日前から始まっていることが分かる
  * 予防的な行動を取るきっかけになる

**「深い睡眠中のHRV分散が大きい日は、リカバリースコアが低い傾向があります」**

* **発見方法**:
  * 深い睡眠中のHRVの標準偏差を計算
  * HRV分散とリカバリースコアの相関を分析

* **ユーザーが気づいていない点**:
  * HRVの「安定性」も回復状態を反映することが分かる

---

### 3. 活動量と回復の関係

#### インサイト例

**「歩数が8000歩以上の日の翌日は、深い睡眠が平均12%増加しています」**

* **発見方法**:
  * 歩数で日を分類（例：8000歩以上 vs 8000歩未満）
  * 翌日の深い睡眠の割合を比較

* **ユーザーが気づいていない点**:
  * 適度な運動が睡眠の質を向上させることを数値で確認できる
  * 自分の最適な活動量が分かる

**「アクティブエネルギーが高い日の翌日は、HRVが平均8%低下しています（オーバートレーニングの可能性）」**

* **発見方法**:
  * アクティブエネルギーで日を分類
  * 翌日のHRVを比較

* **ユーザーが気づいていない点**:
  * 過度な活動が回復を妨げている可能性を発見できる
  * 適切な活動量のバランスが分かる

**「歩数が少ない日（5000歩未満）が3日連続すると、リカバリースコアが平均20pt低下します」**

* **発見方法**:
  * 連続する低活動日のパターンを検出
  * リカバリースコアへの影響を分析

* **ユーザーが気づいていない点**:
  * 運動不足の蓄積が回復に影響することが分かる

---

### 4. 心拍数パターンの発見

#### インサイト例

**「安静時心拍数がベースラインより5bpm以上高い日は、その前日にアクティブエネルギーが高かった可能性があります」**

* **発見方法**:
  * 安静時心拍数が高い日を特定
  * 前日のアクティブエネルギーを分析

* **ユーザーが気づいていない点**:
  * 前日の活動が翌日の回復に影響することが分かる

**「安静時心拍数とHRVの相関が強い日は、ストレススコアが高い傾向があります」**

* **発見方法**:
  * 安静時心拍数とHRVの相関係数を計算
  * ストレススコアとの関係を分析

* **ユーザーが気づいていない点**:
  * 心拍数とHRVのバランスがストレス状態を反映することが分かる

---

### 5. 週次・月次のパターン発見

#### インサイト例

**「過去4週間で、月曜日のリカバリースコアが最も低く（平均45pt）、金曜日が最も高い（平均75pt）傾向があります」**

* **発見方法**:
  * 曜日ごとのリカバリースコアを集計
  * 週次パターンを可視化

* **ユーザーが気づいていない点**:
  * 週の疲労パターンが明確になる
  * 「月曜日がつらい」という体感の理由が分かる

**「あなたの睡眠の質は、月の前半（1-15日）と後半（16-31日）で平均8%異なります」**

* **発見方法**:
  * 月の前半と後半で睡眠データを比較

* **ユーザーが気づいていない点**:
  * 月単位のパターン（仕事のサイクル、生理周期など）が影響している可能性を発見

**「過去30日間で、リカバリースコアが50pt未満の日は、その前3日間の平均歩数が6000歩未満でした」**

* **発見方法**:
  * リカバリースコアが低い日を特定
  * 前3日間の活動量を分析

* **ユーザーが気づいていない点**:
  * 回復不良の予測因子を発見できる

---

### 6. 異常値とアラート

#### インサイト例

**「昨日のHRVが過去30日の平均より25%低く、リカバリースコアが40ptでした。今日は休息を優先することをお勧めします。」**

* **発見方法**:
  * ベースラインからの乖離度を計算
  * 異常に低い値を検出

* **ユーザーが気づいていない点**:
  * 体感では気づかない回復不良を早期に発見できる

**「深い睡眠が15%未満の日が3日連続しています。睡眠の質を改善する対策を検討してください。」**

* **発見方法**:
  * 連続する低品質睡眠を検出

* **ユーザーが気づいていない点**:
  * 睡眠の質の低下が継続していることに気づける

---

### 7. 個人のベースラインとの比較

#### インサイト例

**「あなたのHRVベースラインは52msです。過去30日間で、このベースラインを上回った日は8日（27%）でした。」**

* **発見方法**:
  * 過去30日のHRV平均をベースラインとして計算
  * ベースラインを上回った日の割合を計算

* **ユーザーが気づいていない点**:
  * 自分の「良い状態」の基準が分かる
  * 回復状態の頻度を把握できる

**「あなたの最適な睡眠時間は7時間30分です。この時間に近い日のリカバリースコアが最も高くなっています。」**

* **発見方法**:
  * 睡眠時間ごとにリカバリースコアを集計
  * 最もスコアが高い睡眠時間を特定

* **ユーザーが気づいていない点**:
  * 自分にとって最適な睡眠時間が分かる

---

## インサイトの実装方法

### 1. パターン検出アルゴリズム

```python
def detect_weekly_pattern(df):
    """
    週次パターンを検出
    """
    df['weekday'] = df['date'].dt.day_name()
    weekly_avg = df.groupby('weekday')['recovery_score'].mean()
    
    # 最も低い日と高い日を特定
    lowest_day = weekly_avg.idxmin()
    highest_day = weekly_avg.idxmax()
    
    insight = f"過去{len(df)}日間で、{lowest_day}のリカバリースコアが最も低く（平均{weekly_avg[lowest_day]:.0f}pt）、{highest_day}が最も高い（平均{weekly_avg[highest_day]:.0f}pt）傾向があります。"
    
    return insight

def detect_sleep_hrv_correlation(df):
    """
    睡眠の質とHRVの関係を検出
    """
    # 睡眠時間が同じ日のグループを作成
    df['sleep_hour_bin'] = (df['sleep_minutes'] / 60).round()
    
    # 深い睡眠の割合とHRVの関係を分析
    correlation = df.groupby('sleep_hour_bin').agg({
        'deep_sleep_ratio': 'mean',
        'hrv_avg': 'mean'
    })
    
    # 相関を計算
    corr = df['deep_sleep_ratio'].corr(df['hrv_avg'])
    
    if corr > 0.3:
        insight = f"深い睡眠の割合とHRVには強い正の相関があります（相関係数: {corr:.2f}）。深い睡眠を増やすことで、HRVの向上が期待できます。"
    else:
        insight = f"深い睡眠の割合とHRVの相関は弱いです（相関係数: {corr:.2f}）。他の要因も影響している可能性があります。"
    
    return insight

def detect_activity_recovery_relationship(df):
    """
    活動量と回復の関係を検出
    """
    # 歩数でグループ化
    df['steps_category'] = pd.cut(df['steps'], 
                                   bins=[0, 5000, 8000, 10000, float('inf')],
                                   labels=['低', '中', '高', '非常に高'])
    
    # 翌日のリカバリースコアを分析
    df['next_day_recovery'] = df['recovery_score'].shift(-1)
    
    activity_recovery = df.groupby('steps_category')['next_day_recovery'].mean()
    
    # 最適な活動量を特定
    optimal_category = activity_recovery.idxmax()
    
    insight = f"歩数が{optimal_category}の日の翌日は、リカバリースコアが最も高くなっています（平均{activity_recovery[optimal_category]:.0f}pt）。"
    
    return insight
```

### 2. 週次レポートの生成

```python
def generate_weekly_insights(df):
    """
    週次インサイトを生成
    """
    insights = []
    
    # 1. 週次パターン
    insights.append(detect_weekly_pattern(df))
    
    # 2. 睡眠とHRVの関係
    insights.append(detect_sleep_hrv_correlation(df))
    
    # 3. 活動量と回復の関係
    insights.append(detect_activity_recovery_relationship(df))
    
    # 4. 異常値の検出
    if df['recovery_score'].iloc[-1] < 50:
        insights.append(f"今週のリカバリースコアが平均{df['recovery_score'].mean():.0f}ptと低めです。休息を優先することをお勧めします。")
    
    return insights
```

---

## インサイトの表示方法

### 週次レポート形式

```
【先週のあなたのパターン】

1. 週次パターン
   ・月曜日のリカバリースコアが最も低く（平均45pt）、金曜日が最も高い（平均75pt）傾向があります。

2. 睡眠とHRVの関係
   ・深い睡眠が20%未満の日の翌日は、HRVが平均15%低下しています。
   ・同じ睡眠時間（7時間）でも、深い睡眠の割合が10%違うだけでHRVが20%変動しています。

3. 活動量と回復の関係
   ・歩数が8000歩以上の日の翌日は、深い睡眠が平均12%増加しています。
   ・アクティブエネルギーが高い日の翌日は、HRVが平均8%低下しています（オーバートレーニングの可能性）。

4. 今週の注意点
   ・昨日のHRVが過去30日の平均より25%低く、リカバリースコアが40ptでした。
   ・今日は休息を優先することをお勧めします。
```

---

## 実装の優先順位

### 高優先度（最初に実装）

1. **週次パターンの検出**
   - 曜日ごとのリカバリースコアの比較
   - 実装が簡単で、ユーザーが直感的に理解できる

2. **睡眠の質とHRVの関係**
   - 深い睡眠の割合とHRVの相関
   - ユーザーが「確かにそうだ」と思えるインサイト

3. **活動量と回復の関係**
   - 歩数と翌日のリカバリースコアの関係
   - 行動変容につながりやすい

### 中優先度（次に実装）

4. **異常値の検出**
   - ベースラインからの乖離度
   - アラートとして価値が高い

5. **個人のベースラインとの比較**
   - 最適な睡眠時間の特定
   - パーソナライズされたインサイト

### 低優先度（将来的に実装）

6. **月次パターンの検出**
   - データが蓄積されてから実装

7. **複合的なパターン検出**
   - より高度な分析が必要

---

## 期待される効果

Phase 1のデータのみからでも、以下のような価値を提供できます：

1. **「同じ睡眠時間なのに疲れが違う」理由が分かる**
   - 深い睡眠の割合の影響を数値で理解

2. **週の疲労パターンが明確になる**
   - 曜日ごとの回復状態を可視化

3. **最適な活動量が分かる**
   - 歩数と回復の関係を発見

4. **回復不良を早期に発見**
   - 異常値の検出とアラート

5. **個人のベースラインを理解**
   - 自分にとっての「良い状態」が分かる

これらのインサイトは、**カレンダーやスマホ利用時間のデータがなくても、十分に価値のある気づき**を提供できます。

